<include file="__THEME__/public_header" />
<script src="__THEME__/js/jquery.js"></script>
<div class="content" style="">
	<div class="wrap">
		<!--左-->
	    <include file="../User/_left" />
	    <!--右-->
	    <div class="jgpage_right">
		    <div class="user-Release" style="margin-top:0">
			    <style type="text/css">
		            .modify_pe{ width:610px;height: auto; line-height:30px; position:relative; float:left; }
		            .modify_pe input{position:absolute;top:0;left:0px;height:28px;border:1px solid #CCC;vertical-align:middle;padding:0 5px;color:#666; width:200px;}
		            .modify_pe input:focus{border-color:#2388c0}
		            .modify_pe a{color:#2388c0; margin-left:10px; vertical-align:middle}
		            .modify_pe a.btn{position:absolute;top:0;left:210px;height:30px;padding:0 15px; line-height:30px;background:#2B92F9;color:#FFF;}
		            .modify_pe a.btn:hover{background:#1981E8;}
		            .modify_pe p{display:block;height:18px;position:absolute; text-indent:22px;line-height:18px;top:5px; left:330px; font-size:12px; color:#999999}
		            .user-set-sz li p{ left:115px}
		            .user-set-sz{ padding-left:130px}
		            .user-set-sz .user-submit{ width:332px;margin-top:30px;}
		            .user-set-sz input{margin:0;}
		            .user-set-sz label{margin-right:20px;}
		            .select {margin-right: 15px !important;height: 38px;width: 121px;border-radius: 4px;border: solid 1px #b6c7d6;line-height: 34px;padding: 0;}
					.mzLevel {margin-right: 19px !important;height: 38px;width: 121px;border-radius: 4px;border: solid 1px #b6c7d6;line-height: 34px;padding: 0;}
		        </style>
		   		<div class="jgpage_right_con" style="padding:0 30px 30px;">
                	<div class="jgbox" style="padding:0 100px 50px">
					    <div class=" Manage_all" id="basic_sets">
							<if condition="!$verifyInfo">
				        	<form action="" method="post" onsubmit="return false;">
				            <!-- start modify phone -->
				            <php>if($user['phone']):</php>
				            <div class="clearfix modify_phone" style="display:none">
				            	<span class="selected_title  fl">
				                   <span>*</span> 手机号：
				                </span>
				                <div class="modify_pe fl">
				                	<php>$phone = substr($user['phone'],0,3).'****'.substr( $user['phone'] , 7);</php>
				                	<strong>{$phone}</strong><a href="javascript:;" type="code" step="1" class="btn" >获取验证码</a><p class="warn">手机号用于密码找回和重要信息接收</p>
				                </div>
				            </div>
				            <div class="clearfix modify_phone" style="display:none">
				            	<span class="selected_title selected_title_a color_hui fl">
				                   <span>*</span> 验证码：
				                </span>
				                <div class="modify_pe fl"><input type="text" value="" class="user-width fl" /><a href="javascript:;" class="btn" type="submit" step="1" >提交</a><p></p>
				                </div>
				            </div>
				            <php>endif;</php>
						        <!-- 新号码 -->
						        <div class="clearfix modify_phone check" style="display:none">
						        	<span class="selected_title  fl">
						               <span>*</span> 新手机号：
						            </span>
						            <div class="modify_pe fl"><input type="text" value="" class="user-tex border" /><a href="javascript:;" class="btn" type="code" step="2" style="width:91px;text-align:center">获取验证码</a><p>手机号用于密码找回和重要信息接收</p>
						            </div>
						        </div>
						        <div class="clearfix  modify_phone check" style="display:none">
						        	<span class="selected_title fl">
						               <span>*</span> 验证码：
						            </span>
						            <div class="modify_pe fl"><input type="text" value="" /><a href="javascript:;" class="btn" type="submit" step="2">提交</a><p></p>
						            </div>
						        </div>
								<!-- end modify phone -->
								<div class="jgformitem">
									<include file="../Public/_file_uoload_style" />
							        <label class="label"><span>*</span> LOGO：</label>
									<div  class="user-tex charge" style="<eq name='logo' value=''>display: block;<else/>display: none;</eq>">
									{:W('Upload',array('inputname'=>'attach','attachIds'=>$default, 'uploadType'=>'image', 'urlquery'=>'attach_type=feed_image&upload_type=image&thumb=1'))}
									</div>
									<div class="user-tex image" style="<eq name='logo' value=''>display: none;</eq>">
									<img src="{:getCover($logo,100,100)}" style="width: 56px;height: 56px;">
									</div>
									<a id="modify_logo" href="javascript:;" class="jg_bj">修改</a>
							    </div>
								<div class="jgformitem">
							        <label class="label"><span>*</span> 登录帐号：</label>
							        {$user.login}
							    </div>
							    <div class="jgformitem">
							        <label class="label"><span>*</span> 机构名称：</label>
							        <input name="title" class="jg_input"  type="text"  value="{$title}">
							    </div>
							    <div class="jgformitem">
							        <label class="label"><span>*</span> 联系电话：</label>
									<php>if(!$phone){</php>
							        	<php>;$phone = $user['phone']?substr($user['phone'],0,3).'****'.substr( $user['phone'] , 7):'未设置'</php>
									<php>}</php>
							        <div class="user-tex">{$phone}</div><a id="modify_phone" href="javascript:;" class="jg_bj">{$user['phone']?'修改':'设置'}</a>
							        <p style=" display:none"><em class="user-stop"></em>用于密码找回和重要信息接收</p>
							    </div>
						    	<div class="jgformitem modify_email">
							        <label class="label"><span>*</span> 常用邮箱：</label>
							        <div id="modify_pe_show" class="user-tex">{$user.email}<a style="color:#65addd" href="javascript:;" {$user['mail_activate']?'':'type="activate"'}>{$user['mail_activate']?'已验证':'验证邮箱'}</a></div>
							        <a href="javascript:;" type="edit" class="jg_bj">修改</a>
							        <div id="modify_pe_edit" style="display:none"><input class="user-tex" type="text" value="{$user.email}" old="{$user.email}" /><a href="javascript:;" class="user-btn" type="save">保存</a></div>
							        <p style=" display:none"><em class="user-stop"></em><span class="note">用于密码找回和重要信息接收</span></p>
							    </div>
							    <div class="jgformitem" style="width: 450px;">
							        <label class="label"><span>*</span> 地区：</label>
							         <php>$area = $province.','.$city.','.$area;</php>
                            		{:W('CategoryLevel',array('table'=>'area','id'=>'city_ids_','default'=>rtrim($area,',')))}
							    </div>
							    <div class="jgformitem" style="width: 450px;">
							        <label class="label"><span>*</span> 机构类型：</label>
									<php>$fullcategorypaths = trim($fullcategorypath , ',');</php>
									{:W('CategoryLevel',array('table'=>'school_category','id'=>'school_category_id','default'=>trim($fullcategorypath, ',')))}
							    </div>
							    <div class="jgformitem">
							        <label class="label"><span>*</span> 机构简介：</label>
									<textarea class="jg_textarea" name="info">{$info}</textarea>
							    </div>
								<div class="jgformitem">
							        <label class="label">&nbsp;</label>
							        <input  class="jg_btn" type="submit"  onclick="setSchoolInfo(this)" value="提 交">
							    </div>
						    </form>
								<else/>
									<div class="jgformitem" style="font-size: 16px;">
										提交成功，请等待审核！
									</div>
									<div class="jgformitem">
										<include file="../Public/_file_uoload_style" />
										<label class="label"><span>*</span> LOGO：</label>
										<div class="user-tex image" >
											<img src="{:getCover($logo,100,100)}" style="width: 56px;height: 56px;">
										</div>
									</div>
									<div class="jgformitem">
										<label class="label"><span>*</span> 登录帐号：</label>
										{$user.login}
									</div>
									<div class="jgformitem">
										<label class="label"><span>*</span> 机构名称：</label>
										<input name="title" class="jg_input"  readonly="readonly" type="text"  value="{$verifyInfo.title}">
									</div>
									<div class="jgformitem">
										<label class="label"><span>*</span> 联系电话：</label>
										<php>if(!$phone){</php>
											<php>;$phone = $user['phone']?substr($user['phone'],0,3).'****'.substr( $user['phone'] , 7):'未设置'</php>
										<php>}</php>
										<div class="user-tex">{$phone}</div>
									</div>
									<div class="jgformitem modify_email">
										<label class="label"><span>*</span> 常用邮箱：</label>
										<div id="modify_pe_show" class="user-tex">{$user.email}</div>
									</div>
									<div class="jgformitem" style="width: 450px;">
										<label class="label"><span>*</span> 地区：</label>
										<php>$area = $province.','.$city.','.$area;</php>
                            		{:W('CategoryLevel',array('table'=>'area','id'=>'city_ids_','default'=>rtrim($area,',')))}
									</div>
									<div class="jgformitem" style="width: 450px;">
										<label class="label"><span>*</span> 机构类型：</label>
										<php>$fullcategorypaths = trim($fullcategorypath , ',');</php>
										{:W('CategoryLevel',array('table'=>'school_category','id'=>'school_category_id','default'=>trim($fullcategorypath, ',')))}
									</div>
									<div class="jgformitem">
										<label class="label"><span>*</span> 机构简介：</label>
										<textarea class="jg_textarea" readonly="readonly" name="info">{$verifyInfo.info}</textarea>
									</div>
							</if>
				   		</div>
		   			</div>
		   		</div>
			</div>
		</div>
	</div>
</div>
<script>
$(".user-con-title a").click(function(){
	$(this).addClass("onactive").siblings().removeClass();
	var index = $(this).index();
	$(".Manage_all").hide().eq(index).show();
});
$('#modify_phone').click(function(){
	$(this).parents('.Manage_all form').children().hide();
	$('#basic_sets .modify_phone').hide().slice(0,2).show();
});
$('#basic_sets .modify_phone a').click(function(){
	var _this = $(this);
	if(_this.data('locked')) return;
	_this.data('locked', true);

	var type  = _this.attr('type');
	var step  = _this.attr('step');
	var span  = _this.next();
	var input = _this.prev();
	input.val($.trim(input.val()));
	if(type == 'code'){
		_this.text('正在发送');
		if(_this.attr('step') == 2){
			if(!input.val()){
				span.removeClass().addClass('err').text('请先输入手机号');
				input.focus(); _this.data('locked', false); return ;
			}
			var post = {phone:input.val()}
		}else{
			post = {}
		}
		$.post(U('classroom/User/sendCode'),post, function(data){
			if(data == 'ok'){
				span.removeClass().addClass('ok').text('短信验证码已发送至您的手机，请输入后继续');
				var time = 90;
				var _codesetInterval = setInterval(function(){
					 if(time <= 0){
						 _this.text('获取验证码').data('locked', false);
						 clearInterval(_codesetInterval);
					 }else{
						 _this.text('重新获取( '+time+' )');
						 time--;
					 }
				}, 1000);
			}else{
				span.removeClass().addClass('err').text(data);
				_this.text('获取验证码').data('locked', false);
			}
		});
	}else if(type == 'submit'){
		span.removeClass().text('')
		if(!input.val()){
			 notes('请输入验证码','failure');
			input.focus();_this.data('locked', false);return;
		}
		var post = {code:input.val()};
		if(_this.attr('step') == 2){
			var input0 = _this.parents('.modify_phone').prev().find('input:first');
			if(!input0.val()){
				input0.next().next().removeClass()
				 .addClass('err').text('请先输入手机号');
				 _this.data('locked', false);
				input0.focus(); return ;
			}
			post.phone = input0.val();
		}
		$.post(U('classroom/User/checkCode'),post,function(data){
			if(data == 'ok'){
				if(typeof post.phone == 'undefined'){
					var box = $('#basic_sets .modify_phone').hide();
					box.slice(0,2).hide(); box.slice(2,4).show();
				}else{
					span.addClass('ok').text('手机号已经成功更改');
					setTimeout('window.location.reload()', 2000);
				}
			}else{
				span.addClass('err').text(data);
				_this.data('locked', false);
			}
		});
	}
});

$('.modify_email a').click(function(){
	var _this = $(this);
	var type  = _this.attr('type');
	if(type  == 'edit'){
		$('#modify_pe_edit').show();
		$('#modify_pe_show').hide();
		_this.hide();
		_this.siblings('p').find('span').text('用于密码找回和重要信息接收');
	}else if(type == 'save'){
		var input = _this.prev();
		input.val($.trim(input.val()));
		if(!input.val()||input.val().toLowerCase()
		   ==input.attr('old').toLowerCase()){
			$('#modify_pe_show').show();
			_this.parent().hide().prev().show();
			input.val(input.attr('old'));
		}else if(!/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/.test(input.val())){
			notes('请输入正确的电子邮箱地址！', 'failure');return ;
		}else{
			$.post(U('classroom/User/setEmail'),{email:input.val()},function(data){
				if(data == 'ok'){
					notes('Email已经成功更改', 'success');
					input.val(input.val()).attr('old', input.val());
					_this.parent().hide().prev().show();
					$('#modify_pe_show').show();
					$('#modify_pe_show').find('a').text('验证邮箱')
					.attr('type', 'activate').data('locked', false);
					$('#modify_pe_show span').text(input.val());
					$('#set_user_login').text(input.val());
					_this.parent().siblings('p').find('span').text('用于密码找回和重要信息接收');
				}else{
					notes(data, 'failure');
				}
			});
		}
	}else if(type == 'activate'){
		var _this = $(this);
		if(_this.data('locked')){
			return ;
		}
		_this.text('正在发送').data('locked', true);
		$.post(U('classroom/User/sendEmailActivate'),function(data){
			var span = _this.parent().siblings('p').find('span');
			if(data == 'ok'){
				notes('邮件已经发送成功！', 'success');
				_this.text('发送成功');
				span.removeClass().addClass('ok').text('激活邮件已发送，请登录邮箱点击链接进行验证');
			}else{
				notes(data, 'failure');
				_this.text('重新发送').data('locked', false);
				span.removeClass().addClass('err').text(data);
			}
		});
	}
});

$(function(){
	$("#modify_logo").click(function(){
		$(".charge").show();
		$(".image").hide();
	})
	$("#set_banner").click(function(){
		$(".charge2").show();
		$(".image2").hide();
	})
});
function setSchoolInfo(a){
	var form = $(a).parents('form');
	var city_ids_hidden = form.find('input[name="city_ids_hidden"]').val();
	var title    = form.find('input[name=title]');
	if($("#school_categoryhidden").val()==0){
		notes('请选择机构类型', 'failure');
		return false;
	}
	if(!$.trim(title.val())){
		notes('机构名称必须要填写', 'failure');
		title.focus(); return false;
	}
	if(!/^[\u4E00-\u9FA5\w]{1,}$/.test(title.val())){
		notes('机构名称仅支持中英文、数字、下划线', 'failure');
		title.focus(); return false;
	}
	if(!city_ids_hidden || city_ids_hidden == ''){
		notes('请先选择地区', 'failure');
		return false;
	}
	$.post(U('school/User/doIndex'), form.serialize(), function(data){
		if(data.status){
			notes(data.info, 'success');
			setTimeout('window.location.reload();', 2000);
		}else{
			notes(data.info, 'failure');
		}
	}, 'json');
}
</script>
<include file="__THEME__/public_footer" />
